
######################################
# Author: Marijana Vujkovic
# Date: 05/2017
#
# snptest.rules
######################################

# create .sample including phenotypes and covariates
rule create_sample:
        output:
                "out/PROMIS/imputed/GWAS{cohort}/promis_gwas{cohort}.sample"
        shell:
                """
                Rscript R/create_sample.R '{wildcards.cohort}'
                """

# SNPTEST association
rule snptest:
        input:
                sample = "/project/saleheenlab/snakemake/out/PROMIS/imputed/GWAS{cohort}/promis_gwas{cohort}.sample",
                exclude = "/project/saleheenlab/original_data/PROMIS_GWAS12_1kG_phase3_imputed/GWAS{cohort}/promis_gwas{cohort}_sample_exclusion.list"
        output:
                "out/PROMIS/imputed/GWAS{cohort}/{pheno}/chr{chr}/promis_chr_{chr}_{from}e6_{to}e6.out"
        shell:
                """
                /project/saleheenlab/software/SNPTEST/snptest_v2.5.2/snptest_v2.5.2_linux_x86_64_static/snptest_v2.5.2 \
                -data /project/saleheenlab/original_data/PROMIS_GWAS12_1kG_phase3_imputed/GWAS{wildcards.cohort}/by_chr/chr{wildcards.chr}/promis_gwas{wildcards.cohort}_chr_{wildcards.chr}_{wildcards.from}e6_{wildcards.to}e6.gz {input.sample} \
                -o {output} \
                -genotype_field GP \
                -frequentist 1 \
                -method score \
                -pheno {wildcards.pheno} \
                -exclude_samples {input.exclude} \
                -hwe
                """

# extract all snptest files (for merging)
rule snptest_list:
        output:
                "out/PROMIS/imputed/GWAS{cohort}/{pheno}/{pheno}_snptest_chunks_gwas{cohort}.txt"
        shell:
                """
                file out/PROMIS/imputed/GWAS{wildcards.cohort}/{wildcards.pheno}/*/* | sed 's/[:].*$//' >> {output}
                """

# merge all snptest files
rule merge_all:
        input:
                "out/PROMIS/imputed/GWAS{cohort}/{pheno}/{pheno}_snptest_chunks_gwas{cohort}.txt"
        output:
                "out/PROMIS/imputed/GWAS{cohort}/{pheno}/summary/snptest_gwas{cohort}.out"
        shell:
                """
                RScript R/merge_snptest.R '{wildcards.cohort}' '{wildcards.pheno}'
                """
