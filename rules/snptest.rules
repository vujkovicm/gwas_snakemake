
######################################
# Author: Marijana Vujkovic
# Date: 05/2017
#
# snptest.rules
######################################

# create .sample including phenotypes and covariates
rule create_sample:
        output:
                "out/PROMIS/imputed/GWAS{cohort}/promis_gwas{cohort}.sample"
        shell:
                """
                Rscript R/create_sample.R '{wildcards.cohort}'
                """

# SNPTEST association
rule snptest:
        input:
                sample = "/project/saleheenlab/snakemake/out/PROMIS/imputed/GWAS{cohort}/promis_gwas{cohort}.sample",
                exclude = "/project/saleheenlab/original_data/PROMIS_GWAS12_1kG_phase3_imputed/GWAS{cohort}/promis_gwas{cohort}_sample_exclusion.list"
        output:
                "out/PROMIS/imputed/GWAS{cohort}/{pheno}/chr{chr}/promis_chr_{chr}_{from}e6_{to}e6.out"
        shell:
                """
                /project/saleheenlab/software/SNPTEST/snptest_v2.5.2/snptest_v2.5.2_linux_x86_64_static/snptest_v2.5.2 \
                -data /project/saleheenlab/original_data/PROMIS_GWAS12_1kG_phase3_imputed/GWAS{wildcards.cohort}/by_chr/chr{wildcards.chr}/promis_gwas{wildcards.cohort}_chr_{wildcards.chr}_{wildcards.from}e6_{wildcards.to}e6.gz {input.sample} \
                -o {output} \
                -genotype_field GP \
                -frequentist 1 \
                -method score \
                -pheno {wildcards.pheno} \
                -exclude_samples {input.exclude} \
                -hwe
                """

# extract all snptest files (for merging)
rule snptest_list:
        output:
                "out/PROMIS/imputed/GWAS{cohort}/{pheno}/{pheno}_snptest_chunks_gwas{cohort}.txt"
        shell:
                """
                file out/PROMIS/imputed/GWAS{wildcards.cohort}/{wildcards.pheno}/*/* | sed 's/[:].*$//' >> {output}
                """


# merge all snptest files
# maf >= .01 or maf >= .05, hwe >= 10xe06, info >= .8
rule merge_all:
        input:
                "out/PROMIS/imputed/GWAS{cohort}/{pheno}/{pheno}_snptest_chunks_gwas{cohort}.txt"
        output:
                maf001 = "out/PROMIS/imputed/summary/{pheno}/{pheno}_gwas{cohort}.snptest.maf001.out",
                maf005 = "out/PROMIS/imputed/summary/{pheno}/{pheno}_gwas{cohort}.snptest.maf005.out"
        shell:
                """
                echo 'filename alternate_ids rsid chromosome position alleleA alleleB index average_maximum_posterior_call info cohort_1_AA cohort_1_AB cohort_1_BB cohort_1_NULL all_AA all_AB all_BB all_NULL all_total all_maf missing_data_proportion cohort_1_hwe frequentist_add_pvalue frequentist_add_info frequentist_add_beta_1 frequentist_add_se_1 comment' > {output.maf001}
                awk 'FNR > 15 {{if ($9 >= 0.8 && $19 >= 0.01 && $21 >= 0.000001) print FILENAME " " $0}}' out/PROMIS/imputed/GWAS{wildcards.cohort}/{wildcards.pheno}/*/*.out >> {output.maf001}
                echo 'filename alternate_ids rsid chromosome position alleleA alleleB index average_maximum_posterior_call info cohort_1_AA cohort_1_AB cohort_1_BB cohort_1_NULL all_AA all_AB all_BB all_NULL all_total all_maf missing_data_proportion cohort_1_hwe frequentist_add_pvalue frequentist_add_info frequentist_add_beta_1 frequentist_add_se_1 comment' > {output.maf005}
                awk 'FNR > 15 {{if ($9 >= 0.8 && $19 >= 0.05 && $21 >= 0.000001) print FILENAME " " $0}}' out/PROMIS/imputed/GWAS{wildcards.cohort}/{wildcards.pheno}/*/*.out >> {output.maf005}
                """

#create metal file
rule create_metal:
        input:
                "out/PROMIS/imputed/summary/{pheno}/{pheno}_gwas1.snptest.maf{maf}.out",
                "out/PROMIS/imputed/summary/{pheno}/{pheno}_gwas2.snptest.maf{maf}.out"
        output:
                "script/promis_{pheno}.maf{maf}.metal"
        shell:
                """
                Rscript R/create_metal.R '{wildcards.pheno}' '{wildcards.maf}'
                """

# run meta-analysis
rule run_metal:
        input:
                "script/promis_{pheno}.maf{maf}.metal"
        output:
                "out/PROMIS/imputed/summary/{pheno}/promis_{pheno}.metal.maf{maf}.TBL"
        shell:
                """
                /project/saleheenlab/software/METAL/generic-metal/metal {input}
                """

